import { 資源名s, ロールs } from "../../../constants";
import {
  作業着手,
  内部査読依頼,
  内部査読依頼取り消し,
  外部公開,
  外部公開停止,
  再検討依頼,
  再検討依頼取り消し,
  受理,
  受理取り消し,
} from "./model";
import { 新年度評価初期化 } from "../stock";
import {
  create評価担当者,
  create資源評価管理者,
  to認証済評価担当者,
  to認証済資源評価管理者,
} from "../../user";
import { describe, it, expect } from "vitest";
import type { 主担当者, 副担当者 } from "../../user";
import {
  create未着手の資源評価,
  create作業中の資源評価,
  create内部査読中の資源評価,
  create内部査読受理済みの資源評価,
  create外部査読中の資源評価,
  create再検討中の資源評価_内部査読中から,
  create再検討中の資源評価_外部査読中から,
} from "@/test-helpers";

// Default test version number for status changes
const テスト用バージョン = 1;

describe("作業着手", () => {
  it("資源評価のステータスを「未着手」から「作業中」に変更する", () => {
    // Arrange
    const 未着手の資源評価 = create未着手の資源評価();
    const 主担当者 = create評価担当者("user-1", "マイワシ太郎", "maiwashi-taro@example.com", {
      [資源名s.マイワシ太平洋]: ロールs.主担当,
    });
    const 認証済み主担当者 = to認証済評価担当者(主担当者) as 主担当者;
    const 着手日時 = new Date("2025-01-01T09:00:00Z");

    // Act
    const { 進行中資源評価 } = 作業着手(未着手の資源評価, 着手日時, 認証済み主担当者);

    // Assert
    expect(進行中資源評価.作業ステータス).toBe("作業中");
    expect(進行中資源評価.対象).toEqual(未着手の資源評価.対象);
  });

  it("作業着手イベントを正しく生成する", () => {
    // Arrange
    const 未着手の資源評価 = create未着手の資源評価();
    const 主担当者 = create評価担当者("user-1", "マイワシ太郎", "maiwashi-taro@example.com", {
      [資源名s.マイワシ太平洋]: ロールs.主担当,
    });
    const 認証済み主担当者 = to認証済評価担当者(主担当者) as 主担当者;
    const 着手日時 = new Date("2025-01-01T09:00:00Z");

    // Act
    const { 作業着手済み } = 作業着手(未着手の資源評価, 着手日時, 認証済み主担当者);

    // Assert
    expect(作業着手済み.変化前).toBe("未着手");
    expect(作業着手済み.変化後).toBe("作業中");
    expect(作業着手済み.変化理由).toBe("作業着手");
    expect(作業着手済み.日時).toEqual(着手日時);
    expect(作業着手済み.操作者).toBe(認証済み主担当者);
  });

  it("作業着手イベントのtoStringが正しく動作する", () => {
    // Arrange
    const 未着手の資源評価 = create未着手の資源評価();
    const 主担当者 = create評価担当者("user-1", "マイワシ太郎", "maiwashi-taro@example.com", {
      [資源名s.マイワシ太平洋]: ロールs.主担当,
    });
    const 認証済み主担当者 = to認証済評価担当者(主担当者) as 主担当者;
    const 着手日時 = new Date("2025-01-01T09:00:00Z");

    // Act
    const { 作業着手済み } = 作業着手(未着手の資源評価, 着手日時, 認証済み主担当者);

    // Assert
    expect(作業着手済み.toString()).toBe(
      "未着手 → 作業中 by マイワシ太郎 at 2025-01-01T09:00:00.000Z"
    );
  });

  it("immutableな操作", () => {
    // Arrange
    const 未着手の資源評価 = create未着手の資源評価();
    const 主担当者 = create評価担当者("user-1", "マイワシ太郎", "maiwashi-taro@example.com", {
      [資源名s.マイワシ太平洋]: ロールs.主担当,
    });
    const 認証済み主担当者 = to認証済評価担当者(主担当者) as 主担当者;

    // Act
    作業着手(未着手の資源評価, new Date(), 認証済み主担当者);

    // Assert - original should remain unchanged
    expect(未着手の資源評価.作業ステータス).toBe("未着手");
  });

  it.each([
    {
      name: "認証済みの副担当者",
      createUser: () =>
        to認証済評価担当者(
          create評価担当者("user-1", "認証済副担当", "test@example.com", {
            [資源名s.マイワシ太平洋]: ロールs.副担当,
          })
        ),
    },
    {
      name: "担当資源がないユーザー",
      createUser: () =>
        to認証済評価担当者(create評価担当者("user-2", "無担当ユーザー", "test@example.com", {})),
    },
  ])("$name は作業着手できない（主担当者のみ）", ({ createUser }) => {
    const 未着手の資源評価 = create未着手の資源評価();
    const user = createUser();

    expect(() => 作業着手(未着手の資源評価, new Date(), user)).toThrow(
      "主担当者のみが操作できます"
    );
  });

  it("認証済みの主担当者のみが作業着手できる", () => {
    const 未着手の資源評価 = create未着手の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );

    expect(() => 作業着手(未着手の資源評価, new Date(), 認証済み主担当者)).not.toThrow();
  });
});

describe("内部査読依頼", () => {
  it("資源評価のステータスを「作業中」から「内部査読中」に変更する", () => {
    const 作業中の資源評価 = create作業中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 内部査読待ち資源評価 } = 内部査読依頼(
      作業中の資源評価,
      日時,
      認証済み主担当者,
      テスト用バージョン
    );
    expect(内部査読待ち資源評価.作業ステータス).toBe("内部査読中");
    expect(内部査読待ち資源評価.対象).toEqual(作業中の資源評価.対象);
  });

  it("内部査読依頼イベントを正しく生成する", () => {
    const 作業中の資源評価 = create作業中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 内部査読依頼済み } = 内部査読依頼(
      作業中の資源評価,
      日時,
      認証済み主担当者,
      テスト用バージョン
    );
    expect(内部査読依頼済み.変化前).toBe("作業中");
    expect(内部査読依頼済み.変化後).toBe("内部査読中");
    expect(内部査読依頼済み.変化理由).toBe("内部査読依頼");
    expect(内部査読依頼済み.日時).toEqual(日時);
    expect(内部査読依頼済み.操作者).toBe(認証済み主担当者);
  });

  it.each([
    {
      name: "認証済みの副担当者",
      createUser: () =>
        to認証済評価担当者(
          create評価担当者("user-1", "認証済副担当", "test@example.com", {
            [資源名s.マイワシ太平洋]: ロールs.副担当,
          })
        ),
    },
    {
      name: "担当資源がないユーザー",
      createUser: () =>
        to認証済評価担当者(create評価担当者("user-2", "無担当ユーザー", "test@example.com", {})),
    },
  ])("$name は内部査読依頼できない（主担当者のみ）", ({ createUser }) => {
    const 作業中の資源評価 = create作業中の資源評価();
    const user = createUser();

    expect(() => 内部査読依頼(作業中の資源評価, new Date(), user, テスト用バージョン)).toThrow(
      "主担当者のみが操作できます"
    );
  });

  it("認証済みの主担当者のみが内部査読依頼できる", () => {
    const 作業中の資源評価 = create作業中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );

    expect(() =>
      内部査読依頼(作業中の資源評価, new Date(), 認証済み主担当者, テスト用バージョン)
    ).not.toThrow();
  });
});

describe("内部査読依頼取り消し", () => {
  it("資源評価のステータスを「内部査読中」から「作業中」に変更する", () => {
    const 内部査読中の資源評価 = create内部査読中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 進行中資源評価 } = 内部査読依頼取り消し(内部査読中の資源評価, 日時, 認証済み主担当者);
    expect(進行中資源評価.作業ステータス).toBe("作業中");
    expect(進行中資源評価.対象).toEqual(内部査読中の資源評価.対象);
  });

  it("内部査読依頼取り消しイベントを正しく生成する", () => {
    const 内部査読中の資源評価 = create内部査読中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 内部査読依頼取り消し済み } = 内部査読依頼取り消し(
      内部査読中の資源評価,
      日時,
      認証済み主担当者
    );
    expect(内部査読依頼取り消し済み.変化前).toBe("内部査読中");
    expect(内部査読依頼取り消し済み.変化後).toBe("作業中");
    expect(内部査読依頼取り消し済み.変化理由).toBe("内部査読依頼取り消し");
    expect(内部査読依頼取り消し済み.日時).toEqual(日時);
    expect(内部査読依頼取り消し済み.操作者).toBe(認証済み主担当者);
  });

  it.each([
    {
      name: "認証済みの副担当者",
      createUser: () =>
        to認証済評価担当者(
          create評価担当者("user-1", "認証済副担当", "test@example.com", {
            [資源名s.マイワシ太平洋]: ロールs.副担当,
          })
        ),
    },
    {
      name: "担当資源がないユーザー",
      createUser: () =>
        to認証済評価担当者(create評価担当者("user-2", "無担当ユーザー", "test@example.com", {})),
    },
  ])("$name は内部査読依頼を取り消せない（主担当者のみ）", ({ createUser }) => {
    const 内部査読中の資源評価 = create内部査読中の資源評価();
    const user = createUser();

    expect(() => 内部査読依頼取り消し(内部査読中の資源評価, new Date(), user)).toThrow(
      "主担当者のみが操作できます"
    );
  });

  it("認証済みの主担当者のみが内部査読依頼を取り消せる", () => {
    const 内部査読中の資源評価 = create内部査読中の資源評価();
    const 認証済み主担当者 = to認証済評価担当者(
      create評価担当者("user-1", "認証済主担当", "test@example.com", {
        [資源名s.マイワシ太平洋]: ロールs.主担当,
      })
    );

    expect(() =>
      内部査読依頼取り消し(内部査読中の資源評価, new Date(), 認証済み主担当者)
    ).not.toThrow();
  });
});

describe("外部公開", () => {
  it("資源評価のステータスを「外部公開可能」から「外部査読中」に変更する", () => {
    const 内部査読受理済みの資源評価 = create内部査読受理済みの資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 外部査読中資源評価 } = 外部公開(
      内部査読受理済みの資源評価,
      日時,
      認証済み資源評価管理者,
      テスト用バージョン
    );
    expect(外部査読中資源評価.作業ステータス).toBe("外部査読中");
    expect(外部査読中資源評価.対象).toEqual(内部査読受理済みの資源評価.対象);
  });

  it("外部公開イベントを正しく生成する", () => {
    const 内部査読受理済みの資源評価 = create内部査読受理済みの資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 外部公開済み } = 外部公開(
      内部査読受理済みの資源評価,
      日時,
      認証済み資源評価管理者,
      テスト用バージョン
    );
    expect(外部公開済み.変化前).toBe("外部公開可能");
    expect(外部公開済み.変化後).toBe("外部査読中");
    expect(外部公開済み.変化理由).toBe("外部公開");
    expect(外部公開済み.日時).toEqual(日時);
    expect(外部公開済み.操作者).toBe(認証済み資源評価管理者);
  });
});

describe("再検討依頼", () => {
  describe("外部査読中からの再検討依頼", () => {
    it("資源評価のステータスを「外部査読中」から「再検討中」に変更する", () => {
      const 外部査読中の資源評価 = create外部査読中の資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討待ち資源評価 } = 再検討依頼(
        外部査読中の資源評価,
        日時,
        認証済み資源評価管理者,
        テスト用バージョン
      );
      expect(再検討待ち資源評価.作業ステータス).toBe("再検討中");
      expect(再検討待ち資源評価.対象).toEqual(外部査読中の資源評価.対象);
    });

    it("再検討依頼イベントを正しく生成する", () => {
      const 外部査読中の資源評価 = create外部査読中の資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討依頼済み } = 再検討依頼(
        外部査読中の資源評価,
        日時,
        認証済み資源評価管理者,
        テスト用バージョン
      );
      expect(再検討依頼済み.変化前).toBe("外部査読中");
      expect(再検討依頼済み.変化後).toBe("再検討中");
      expect(再検討依頼済み.変化理由).toBe("再検討依頼");
      expect(再検討依頼済み.日時).toEqual(日時);
      expect(再検討依頼済み.操作者).toBe(認証済み資源評価管理者);
    });

    it("副担当者は外部査読中の資源評価に再検討依頼できない", () => {
      const 外部査読中の資源評価 = create外部査読中の資源評価();
      const 認証済み副担当者 = to認証済評価担当者(
        create評価担当者("user-2", "認証済副担当", "test@example.com", {
          [資源名s.マイワシ太平洋]: ロールs.副担当,
        })
      ) as 副担当者;
      const 日時 = new Date("2025-01-01T09:00:00Z");

      expect(() =>
        再検討依頼(外部査読中の資源評価, 日時, 認証済み副担当者, テスト用バージョン)
      ).toThrow("外部査読中の再検討依頼は資源評価管理者のみが操作できます");
    });
  });

  describe("内部査読中からの再検討依頼", () => {
    it("資源評価管理者は内部査読中の資源評価に再検討依頼できる", () => {
      const 内部査読中の資源評価 = create内部査読中の資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討待ち資源評価 } = 再検討依頼(
        内部査読中の資源評価,
        日時,
        認証済み資源評価管理者,
        テスト用バージョン
      );
      expect(再検討待ち資源評価.作業ステータス).toBe("再検討中");
    });

    it("副担当者は内部査読中の資源評価に再検討依頼できる", () => {
      const 内部査読中の資源評価 = create内部査読中の資源評価();
      const 認証済み副担当者 = to認証済評価担当者(
        create評価担当者("user-2", "認証済副担当", "test@example.com", {
          [資源名s.マイワシ太平洋]: ロールs.副担当,
        })
      ) as 副担当者;
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討待ち資源評価 } = 再検討依頼(
        内部査読中の資源評価,
        日時,
        認証済み副担当者,
        テスト用バージョン
      );
      expect(再検討待ち資源評価.作業ステータス).toBe("再検討中");
    });
  });
});

describe("受理", () => {
  it("内部査読中の資源評価を受理する", () => {
    const 内部査読中の資源評価 = create内部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");
    const { 受理済み資源評価, 受理済み } = 受理(
      内部査読中の資源評価,
      日時,
      認証済み資源評価管理者,
      テスト用バージョン
    );
    expect(受理済み資源評価.作業ステータス).toBe("外部公開可能");
    expect(受理済み.変化前).toBe("内部査読中");
    expect(受理済み.変化後).toBe("外部公開可能");
    expect(受理済み.変化理由).toBe("内部査読者による受理");
    expect(受理済み.日時).toEqual(日時);
    expect(受理済み.操作者).toBe(認証済み資源評価管理者);
  });

  it("外部査読中の資源評価を受理する", () => {
    const 外部査読中の資源評価 = create外部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("user-1", "認証済資源評価管理者", "test@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");
    const { 受理済み資源評価, 受理済み } = 受理(
      外部査読中の資源評価,
      日時,
      認証済み資源評価管理者,
      テスト用バージョン
    );
    expect(受理済み資源評価.作業ステータス).toBe("外部査読受理済み");
    expect(受理済み.変化前).toBe("外部査読中");
    expect(受理済み.変化後).toBe("外部査読受理済み");
    expect(受理済み.変化理由).toBe("ステークホルダーによる受理");
    expect(受理済み.日時).toEqual(日時);
    expect(受理済み.操作者).toBe(認証済み資源評価管理者);
  });
});

describe("受理取り消し", () => {
  const create内部査読受理済みの資源評価 = () => {
    const 内部査読中 = create内部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("admin-1", "管理者", "admin@example.com")
    );
    const { 受理済み資源評価 } = 受理(
      内部査読中,
      new Date(),
      認証済み資源評価管理者,
      テスト用バージョン
    );
    return 受理済み資源評価;
  };

  const create外部査読受理済みの資源評価 = () => {
    const 外部査読中 = create外部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("admin-1", "管理者", "admin@example.com")
    );
    const { 受理済み資源評価 } = 受理(
      外部査読中,
      new Date(),
      認証済み資源評価管理者,
      テスト用バージョン
    );
    return 受理済み資源評価;
  };

  describe("内部査読受理の取り消し", () => {
    it("資源評価のステータスを「外部公開可能」から「内部査読中」に変更する", () => {
      const 内部査読受理済みの資源評価 = create内部査読受理済みの資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 査読中資源評価 } = 受理取り消し(
        内部査読受理済みの資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(査読中資源評価.作業ステータス).toBe("内部査読中");
      expect(査読中資源評価.対象).toEqual(内部査読受理済みの資源評価.対象);
    });

    it("内部査読受理取り消しイベントを正しく生成する", () => {
      const 内部査読受理済みの資源評価 = create内部査読受理済みの資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 受理取り消し済み } = 受理取り消し(
        内部査読受理済みの資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(受理取り消し済み.変化前).toBe("外部公開可能");
      expect(受理取り消し済み.変化後).toBe("内部査読中");
      expect(受理取り消し済み.変化理由).toBe("内部査読受理の取り消し");
      expect(受理取り消し済み.日時).toEqual(日時);
      expect(受理取り消し済み.操作者).toBe(認証済み資源評価管理者);
    });
  });

  describe("外部査読受理の取り消し", () => {
    it("資源評価のステータスを「外部査読受理済み」から「外部査読中」に変更する", () => {
      const 外部査読受理済みの資源評価 = create外部査読受理済みの資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 査読中資源評価 } = 受理取り消し(
        外部査読受理済みの資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(査読中資源評価.作業ステータス).toBe("外部査読中");
      expect(査読中資源評価.対象).toEqual(外部査読受理済みの資源評価.対象);
    });

    it("外部査読受理取り消しイベントを正しく生成する", () => {
      const 外部査読受理済みの資源評価 = create外部査読受理済みの資源評価();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 受理取り消し済み } = 受理取り消し(
        外部査読受理済みの資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(受理取り消し済み.変化前).toBe("外部査読受理済み");
      expect(受理取り消し済み.変化後).toBe("外部査読中");
      expect(受理取り消し済み.変化理由).toBe("外部査読受理の取り消し");
      expect(受理取り消し済み.日時).toEqual(日時);
      expect(受理取り消し済み.操作者).toBe(認証済み資源評価管理者);
    });
  });
});

describe("外部公開停止", () => {
  it("資源評価のステータスを「外部査読中」から「外部公開可能」に変更する", () => {
    const 外部査読中の資源評価 = create外部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("admin-1", "管理者", "admin@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 外部公開可能資源評価 } = 外部公開停止(
      外部査読中の資源評価,
      日時,
      認証済み資源評価管理者
    );
    expect(外部公開可能資源評価.作業ステータス).toBe("外部公開可能");
    expect(外部公開可能資源評価.対象).toEqual(外部査読中の資源評価.対象);
  });

  it("外部公開停止イベントを正しく生成する", () => {
    const 外部査読中の資源評価 = create外部査読中の資源評価();
    const 認証済み資源評価管理者 = to認証済資源評価管理者(
      create資源評価管理者("admin-1", "管理者", "admin@example.com")
    );
    const 日時 = new Date("2025-01-01T09:00:00Z");

    const { 外部公開停止済み } = 外部公開停止(外部査読中の資源評価, 日時, 認証済み資源評価管理者);
    expect(外部公開停止済み.変化前).toBe("外部査読中");
    expect(外部公開停止済み.変化後).toBe("外部公開可能");
    expect(外部公開停止済み.変化理由).toBe("外部公開停止");
    expect(外部公開停止済み.日時).toEqual(日時);
    expect(外部公開停止済み.操作者).toBe(認証済み資源評価管理者);
  });
});

describe("再検討依頼取り消し", () => {
  describe("内部査読中への取り消し", () => {
    it("資源評価のステータスを「再検討中」から「内部査読中」に変更する", () => {
      const 再検討中の資源評価 = create再検討中の資源評価_内部査読中から();
      const 認証済み副担当者 = to認証済評価担当者(
        create評価担当者("user-2", "副担当", "sub@example.com", {
          [資源名s.マイワシ太平洋]: ロールs.副担当,
        })
      ) as 副担当者;
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 査読中資源評価 } = 再検討依頼取り消し(再検討中の資源評価, 日時, 認証済み副担当者);
      expect(査読中資源評価.作業ステータス).toBe("内部査読中");
      expect(査読中資源評価.対象).toEqual(再検討中の資源評価.対象);
    });

    it("再検討依頼取り消しイベントを正しく生成する", () => {
      const 再検討中の資源評価 = create再検討中の資源評価_内部査読中から();
      const 認証済み副担当者 = to認証済評価担当者(
        create評価担当者("user-2", "副担当", "sub@example.com", {
          [資源名s.マイワシ太平洋]: ロールs.副担当,
        })
      ) as 副担当者;
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討依頼取り消し済み } = 再検討依頼取り消し(
        再検討中の資源評価,
        日時,
        認証済み副担当者
      );
      expect(再検討依頼取り消し済み.変化前).toBe("再検討中");
      expect(再検討依頼取り消し済み.変化後).toBe("内部査読中");
      expect(再検討依頼取り消し済み.変化理由).toBe("再検討依頼の取り消し");
      expect(再検討依頼取り消し済み.日時).toEqual(日時);
      expect(再検討依頼取り消し済み.操作者).toBe(認証済み副担当者);
    });
  });

  describe("外部査読中への取り消し", () => {
    it("資源評価のステータスを「再検討中」から「外部査読中」に変更する", () => {
      const 再検討中の資源評価 = create再検討中の資源評価_外部査読中から();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 査読中資源評価 } = 再検討依頼取り消し(
        再検討中の資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(査読中資源評価.作業ステータス).toBe("外部査読中");
      expect(査読中資源評価.対象).toEqual(再検討中の資源評価.対象);
    });

    it("再検討依頼取り消しイベントを正しく生成する", () => {
      const 再検討中の資源評価 = create再検討中の資源評価_外部査読中から();
      const 認証済み資源評価管理者 = to認証済資源評価管理者(
        create資源評価管理者("admin-1", "管理者", "admin@example.com")
      );
      const 日時 = new Date("2025-01-01T09:00:00Z");

      const { 再検討依頼取り消し済み } = 再検討依頼取り消し(
        再検討中の資源評価,
        日時,
        認証済み資源評価管理者
      );
      expect(再検討依頼取り消し済み.変化前).toBe("再検討中");
      expect(再検討依頼取り消し済み.変化後).toBe("外部査読中");
      expect(再検討依頼取り消し済み.変化理由).toBe("再検討依頼の取り消し");
      expect(再検討依頼取り消し済み.日時).toEqual(日時);
      expect(再検討依頼取り消し済み.操作者).toBe(認証済み資源評価管理者);
    });
  });
});

describe("新年度評価初期化", () => {
  it("すべての資源に対して未着手の資源評価を作成する", () => {
    const 年度 = 2025;
    const result = 新年度評価初期化(年度);

    // Check that all resources are initialized
    expect(result.年度).toBe(年度);
    const 全資源名 = Object.values(資源名s);
    expect(result.評価一覧.size).toBe(全資源名.length);

    for (const 資源名 of 全資源名) {
      const 評価 = result.評価一覧.get(資源名);
      expect(評価).toBeDefined();
      expect(評価!.作業ステータス).toBe("未着手");
      expect(評価!.対象.toString()).toBe(資源名);
    }
  });

  it("各資源評価は正しい資源情報を持つ", () => {
    const 年度 = 2025;
    const result = 新年度評価初期化(年度);

    const マイワシ評価 = result.評価一覧.get(資源名s.マイワシ太平洋);
    expect(マイワシ評価).toBeDefined();
    expect(マイワシ評価!.対象.呼称).toBe("マイワシ");
    expect(マイワシ評価!.対象.系群名).toBe("太平洋系群");
  });

  it("toString()で初期化結果を文字列化できる", () => {
    const 年度 = 2025;
    const result = 新年度評価初期化(年度);
    const 資源数 = Object.values(資源名s).length;

    expect(result.toString()).toBe(`${年度}年度 資源評価初期化完了（${資源数}件）`);
  });
});
