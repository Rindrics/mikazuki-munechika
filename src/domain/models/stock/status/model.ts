import type { 資源評価 } from "../stock";
import type { 認証済ユーザー } from "../../user";
import type { 主担当者 } from "../../user";
import type { 認証済資源評価管理者 } from "../../user";
import type { 副担当者 } from "../../user";
import type { 認証済評価担当者 } from "../../user";
import type { 資源名 } from "../stock";
import { require主担当者, is資源評価管理者 } from "../../user";

/**
 * 資源評価の作業ステータスを管理する型
 */
export type 評価ステータス =
  | "未着手"
  | "作業中"
  | "内部査読中"
  | "外部公開可能"
  | "外部査読中"
  | "再検討中"
  | "外部査読受理済み";


/**
 * Status-specific assessment types
 */
export type 未着手資源評価 = 資源評価<"未着手">;
// - 作業着手() ->
export type 進行中資源評価 = 資源評価<"作業中">;
// - 内部査読依頼() ->
export type 内部査読中資源評価 = 資源評価<"内部査読中">;
// - 受理() ->
export type 内部査読受理済み資源評価 = 資源評価<"外部公開可能">;
// - 外部公開() ->
export type 外部査読中資源評価 = 資源評価<"外部査読中">;
// - 再検討依頼() ->
export type 再検討中資源評価 = 資源評価<"再検討中">;
// - 受理() ->
export type 外部査読受理済み資源評価 = 資源評価<"外部査読受理済み">;

interface ステータス変化イベント {
  readonly 変化前: 評価ステータス;
  readonly 変化後: 評価ステータス;
  readonly 変化理由: string;
  readonly 日時: Date;
  readonly 操作者: 認証済ユーザー;
  toString(): string;
}

/**
 * 「未着手 → 作業中」のステータス変化を表す型
 */
const 作業着手イベント定義 = {
  変化前: "未着手",
  変化後: "作業中",
  変化理由: "作業着手",
} as const;

type 作業着手済み = ステータス変化イベント &
  typeof 作業着手イベント定義 & {
    readonly 操作者: 主担当者;
  };

/**
 * 「作業中 → 内部査読中」のステータス変化を表す型
 */
const 内部査読依頼イベント定義 = {
  変化前: "作業中",
  変化後: "内部査読中",
  変化理由: "内部査読依頼",
} as const;

/**
 * 「内部査読中 → 外部査読中」のステータス変化を表す型
 */
const 外部公開イベント定義 = {
  変化前: "内部査読中",
  変化後: "外部査読中",
  変化理由: "外部公開",
} as const;

const 再検討依頼イベント定義 = {
  変化前: "外部査読中",
  変化後: "再検討中",
  変化理由: "再検討依頼",
} as const;

const 内部査読受理イベント定義 = {
  変化前: "内部査読中",
  変化後: "外部公開可能",
  変化理由: "内部査読者による受理",
} as const;

const 外部査読受理イベント定義 = {
  変化前: "外部査読中",
  変化後: "外部査読受理済み",
  変化理由: "ステークホルダーによる受理",
} as const;

type 内部査読依頼済み = ステータス変化イベント &
  typeof 内部査読依頼イベント定義 & {
    readonly 操作者: 主担当者;
  };

type 外部公開済み = ステータス変化イベント &
  typeof 外部公開イベント定義 & {
    readonly 操作者: 認証済資源評価管理者;
  };

type 再検討依頼済み = ステータス変化イベント &
  typeof 再検討依頼イベント定義 & {
    readonly 操作者: 認証済資源評価管理者 | 副担当者;
  };

type 内部査読受理済み = ステータス変化イベント &
  typeof 内部査読受理イベント定義 & {
    readonly 操作者: 認証済資源評価管理者;
  };

type 外部査読受理済み = ステータス変化イベント &
  typeof 外部査読受理イベント定義 & {
    readonly 操作者: 認証済資源評価管理者;
  };

  function ステータス遷移<
  TOperator extends 認証済ユーザー,
  TDef extends {
    readonly 変化前: 評価ステータス;
    readonly 変化後: 評価ステータス;
    readonly 変化理由: string;
  },
>(
  対象資源評価: 資源評価,
  日時: Date,
  操作者: TOperator,
  イベント定義: TDef
): {
  更新後資源評価: 資源評価<TDef["変化後"]>;
  イベント: ステータス変化イベント & TDef & { readonly 操作者: TOperator };
} {
  const 更新後資源評価 = Object.create(Object.getPrototypeOf(対象資源評価), {
    ...Object.getOwnPropertyDescriptors(対象資源評価),
    作業ステータス: { value: イベント定義.変化後, writable: false, enumerable: true },
  }) as 資源評価<TDef["変化後"]>;

  const イベント = {
    ...イベント定義,
    日時,
    操作者,
    toString() {
      return `${this.変化前} → ${this.変化後} by ${this.操作者.氏名} at ${this.日時.toISOString()}`;
    },
  };

  return { 更新後資源評価, イベント };
}

export function 作業着手(
  対象資源評価: 未着手資源評価,
  日時: Date,
  操作者: 認証済評価担当者
): { 進行中資源評価: 進行中資源評価; 作業着手済み: 作業着手済み } {
  const 対象資源名 = 対象資源評価.対象.toString() as 資源名;
  require主担当者(操作者, 対象資源名);

  const { 更新後資源評価: 進行中資源評価, イベント: 作業着手済み } = ステータス遷移(
    対象資源評価,
    日時,
    操作者,
    作業着手イベント定義
  );
  return { 進行中資源評価, 作業着手済み };
}

export function 内部査読依頼(
  対象資源評価: 進行中資源評価,
  日時: Date,
  操作者: 認証済評価担当者
): { 内部査読待ち資源評価: 内部査読中資源評価; 内部査読依頼済み: 内部査読依頼済み } {
  const 対象資源名 = 対象資源評価.対象.toString() as 資源名;
  require主担当者(操作者, 対象資源名);

  const { 更新後資源評価: 内部査読待ち資源評価, イベント: 内部査読依頼済み } = ステータス遷移(
    対象資源評価,
    日時,
    操作者,
    内部査読依頼イベント定義
  );
  return { 内部査読待ち資源評価, 内部査読依頼済み };
}

export function 外部公開(
  対象資源評価: 内部査読中資源評価,
  日時: Date,
  操作者: 認証済資源評価管理者
): { 外部査読中資源評価: 外部査読中資源評価; 外部公開済み: 外部公開済み } {
  const { 更新後資源評価: 外部査読中資源評価, イベント: 外部公開済み } = ステータス遷移(
    対象資源評価,
    日時,
    操作者,
    外部公開イベント定義
  );
  return { 外部査読中資源評価, 外部公開済み };
}

export function 再検討依頼(
  対象資源評価: 内部査読中資源評価 | 外部査読中資源評価,
  日時: Date,
  操作者: 認証済資源評価管理者 | 副担当者
): { 再検討待ち資源評価: 再検討中資源評価; 再検討依頼済み: 再検討依頼済み } {
  if (対象資源評価.作業ステータス === "外部査読中") {
    if (!is資源評価管理者(操作者)) {
      throw new Error("外部査読中の再検討依頼は資源評価管理者のみが操作できます");
    }
  }

  const { 更新後資源評価: 再検討待ち資源評価, イベント: 再検討依頼済み } = ステータス遷移(
    対象資源評価,
    日時,
    操作者,
    再検討依頼イベント定義
  );
  return { 再検討待ち資源評価, 再検討依頼済み };
}

export function 受理(
  対象資源評価: 内部査読中資源評価,
  日時: Date,
  操作者: 認証済資源評価管理者
): { 受理済み資源評価: 内部査読受理済み資源評価; 受理済み: 内部査読受理済み };
export function 受理(
  対象資源評価: 外部査読中資源評価,
  日時: Date,
  操作者: 認証済資源評価管理者
): { 受理済み資源評価: 外部査読受理済み資源評価; 受理済み: 外部査読受理済み };
export function 受理(
  対象資源評価: 内部査読中資源評価 | 外部査読中資源評価,
  日時: Date,
  操作者: 認証済資源評価管理者
): {
  受理済み資源評価: 内部査読受理済み資源評価 | 外部査読受理済み資源評価;
  受理済み: 内部査読受理済み | 外部査読受理済み;
} {
  if (対象資源評価.作業ステータス === "内部査読中") {
    const { 更新後資源評価, イベント } = ステータス遷移(
      対象資源評価,
      日時,
      操作者,
      内部査読受理イベント定義
    );
    return { 受理済み資源評価: 更新後資源評価, 受理済み: イベント };
  } else {
    const { 更新後資源評価, イベント } = ステータス遷移(
      対象資源評価,
      日時,
      操作者,
      外部査読受理イベント定義
    );
    return { 受理済み資源評価: 更新後資源評価, 受理済み: イベント };
  }
}
